{% extends "base.html" %}

{% block head %}
<style>
    #drop-area {
        border: 2px dashed #ccc;
        border-radius: 20px;
        padding: 50px;
        text-align: center;
        background-color: #f8f9fa;
        transition: all 0.3s;
    }
    #drop-area.highlight {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }
    .preview-container {
        max-width: 100%;
        margin-top: 20px;
        display: none;
    }
    #upload-progress {
        display: none;
        margin-top: 20px;
    }
    .ratio-option {
        cursor: pointer;
        transition: all 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 15px;
        border-radius: 10px;
        background-color: #f8f9fa;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        position: relative;
        width: 100%;
    }
    .ratio-option:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .ratio-option.selected {
        border: 2px solid #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }
    .aspect-ratio-container {
        position: relative;
        overflow: hidden;
        width: 100%;
        border-radius: 8px;
        background-color: #e9ecef;
        margin-bottom: 15px;
        /* Fixed height for all containers */
        height: 200px;
    }
    .aspect-ratio-container .ratio-inner {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #6c757d;
    }
    /* Display content differently based on aspect ratio */
    .aspect-ratio-container.ratio-9-16 .ratio-content {
        width: 56.25%; /* 9:16 width ratio compared to height */
        height: 85%;
        background-color: white;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .aspect-ratio-container.ratio-1-1 .ratio-content {
        width: 85%;
        height: 85%;
        background-color: white;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .aspect-ratio-container.ratio-4-5 .ratio-content {
        width: 68%; /* 4:5 width ratio compared to height */
        height: 85%;
        background-color: white;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .ratio-title {
        font-weight: 600;
        margin-top: auto;
        color: #495057;
        font-size: 1rem;
    }
    .ratio-subtitle {
        color: #6c757d;
        font-size: 0.85rem;
        margin-top: 5px;
    }
    .hero-section {
        background: linear-gradient(135deg, #4a6bff 0%, #6e30c9 100%);
        color: white;
        padding: 60px 0;
        border-radius: 10px;
        margin-bottom: 40px;
    }
    .feature-icon {
        font-size: 2.5rem;
        color: #4a6bff;
        margin-bottom: 1rem;
    }
    #processing-status {
        display: none;
    }
    #error-message {
        display: none;
    }
    .step {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        transition: all 0.3s;
    }
    .step:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .step-number {
        background: #0d6efd;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
    }
    #url-panel .card {
        border-radius: 20px;
        border: 2px dashed #ccc;
        background-color: #f8f9fa;
        transition: all 0.3s;
    }
    #url-panel .card:hover {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }
    #url-preview {
        display: none;
    }
    /* Better icon styling for ratio options */
    .ratio-option .fa-mobile-alt,
    .ratio-option .fa-square,
    .ratio-option .fa-portrait {
        color: #0d6efd;
    }
    
    .ratio-option.selected .fa-mobile-alt,
    .ratio-option.selected .fa-square,
    .ratio-option.selected .fa-portrait {
        color: #0d47a1;
    }
    
    /* Add a visual indicator for selected option */
    .ratio-option.selected::after {
        content: "\f00c"; /* Font Awesome checkmark */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        top: 10px;
        right: 10px;
        color: #0d6efd;
        font-size: 1.2rem;
    }
    
    /* Equal height row container */
    .ratio-options-container {
        display: flex;
        flex-wrap: wrap;
    }
    
    /* Each ratio option wrapper */
    .ratio-option-wrapper {
        display: flex;
        margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
        .aspect-ratio-container {
            height: 150px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="hero-section text-center">
    <div class="container">
        <h1 class="display-4 fw-bold">VoiceVision</h1>
        <p class="lead">AI-powered smart video cropping that focuses on active speakers</p>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-4">
        <div class="step d-flex flex-column align-items-center text-center">
            <div class="d-flex align-items-center mb-3">
                <div class="step-number">1</div>
                <h3>Upload</h3>
            </div>
            <i class="fas fa-upload feature-icon"></i>
            <p>Upload your video for processing using the secure drag-and-drop interface</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="step d-flex flex-column align-items-center text-center">
            <div class="d-flex align-items-center mb-3">
                <div class="step-number">2</div>
                <h3>Analyze</h3>
            </div>
            <i class="fas fa-brain feature-icon"></i>
            <p>Our AI detects speakers and analyzes who is talking throughout the video</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="step d-flex flex-column align-items-center text-center">
            <div class="d-flex align-items-center mb-3">
                <div class="step-number">3</div>
                <h3>Export</h3>
            </div>
            <i class="fas fa-crop-alt feature-icon"></i>
            <p>Download your video perfectly cropped to focus on the active speakers</p>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <h2 class="card-title text-center mb-4">Process Your Video</h2>
        
        <div id="upload-container">
            <!-- Aspect ratio selection -->
            <h5 class="mb-3">1. Select aspect ratio</h5>
            <div class="ratio-options-container mb-4">
                <div class="row w-100">
                    <div class="col-md-4 ratio-option-wrapper">
                        <div class="ratio-option selected" data-ratio="9:16">
                            <div class="aspect-ratio-container ratio-9-16">
                                <div class="ratio-inner">
                                    <div class="ratio-content">
                                        <i class="fas fa-mobile-alt fa-3x"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="ratio-title text-center">9:16</div>
                            <div class="ratio-subtitle text-center">Vertical - Mobile, TikTok, Stories</div>
                        </div>
                    </div>
                    <div class="col-md-4 ratio-option-wrapper">
                        <div class="ratio-option" data-ratio="1:1">
                            <div class="aspect-ratio-container ratio-1-1">
                                <div class="ratio-inner">
                                    <div class="ratio-content">
                                        <i class="fas fa-square fa-3x"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="ratio-title text-center">1:1</div>
                            <div class="ratio-subtitle text-center">Square - Instagram, Facebook</div>
                        </div>
                    </div>
                    <div class="col-md-4 ratio-option-wrapper">
                        <div class="ratio-option" data-ratio="4:5">
                            <div class="aspect-ratio-container ratio-4-5">
                                <div class="ratio-inner">
                                    <div class="ratio-content">
                                        <i class="fas fa-portrait fa-3x"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="ratio-title text-center">4:5</div>
                            <div class="ratio-subtitle text-center">Portrait - Instagram Feed</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Upload method selection tabs -->
            <h5 class="mb-3">2. Choose video source</h5>
            <ul class="nav nav-tabs mb-3" id="uploadTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button" role="tab" aria-controls="upload-panel" aria-selected="true">
                        <i class="fas fa-upload me-2"></i>Upload Video
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-panel" type="button" role="tab" aria-controls="url-panel" aria-selected="false">
                        <i class="fas fa-link me-2"></i>Video URL
                    </button>
                </li>
            </ul>
            
            <div class="tab-content mb-4" id="uploadTabsContent">
                <!-- Upload area tab -->
                <div class="tab-pane fade show active" id="upload-panel" role="tabpanel" aria-labelledby="upload-tab">
                    <div id="drop-area" class="mb-4">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                        <h4>Drag & Drop Video</h4>
                        <p>or</p>
                        <label for="fileInput" class="btn btn-primary">Choose a Video</label>
                        <input type="file" id="fileInput" style="display:none" accept="video/*">
                        <p class="mt-2 text-muted">Supported formats: MP4, MOV, AVI, WebM</p>
                        <p class="text-muted">Maximum size: 1 GB</p>
                    </div>
                </div>
                
                <!-- URL input tab -->
                <div class="tab-pane fade" id="url-panel" role="tabpanel" aria-labelledby="url-tab">
                    <div class="card p-4">
                        <h4 class="mb-3">Enter Video URL</h4>
                        <div class="form-group mb-3">
                            <label for="videoUrl" class="form-label">Video URL</label>
                            <input type="url" class="form-control" id="videoUrl" placeholder="https://example.com/video.mp4">
                            <div class="form-text">Supported formats: MP4, M3U8 (HLS), etc.</div>
                        </div>
                        <div class="d-grid">
                            <button id="url-submit-btn" class="btn btn-primary">
                                <i class="fas fa-check-circle me-2"></i>Use This URL
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Upload progress -->
            <div id="upload-progress" class="mb-4">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <p class="text-center mt-2" id="upload-status">Uploading...</p>
            </div>
            
            <!-- Preview container -->
            <div class="preview-container text-center mb-4">
                <h5>Video Preview</h5>
                <div class="mb-3" id="url-preview">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="url-preview-text">Processing will begin when you click the button below.</span>
                    </div>
                </div>
                <video id="preview-video" controls class="img-fluid rounded"></video>
                <div class="mt-3">
                    <button id="process-btn" class="btn btn-success"><i class="fas fa-play-circle me-2"></i>Start Processing</button>
                </div>
            </div>
        </div>
        
        <!-- Processing status -->
        <div id="processing-status" class="text-center">
            <h4 class="mb-3">Processing your video...</h4>
            <div class="progress mb-3">
                <div id="processing-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="processing-step">Initializing...</p>
            <div class="mt-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
        
        <!-- Error message -->
        <div id="error-message" class="alert alert-danger text-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="error-text">An error occurred during processing.</span>
            <div class="mt-3">
                <button id="retry-btn" class="btn btn-outline-danger">Try Again</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let selectedFile = null;
    let selectedRatio = '9:16';
    let currentTaskId = null;
    let processingStatusInterval = null;
    let videoUrl = null;
    let videoSource = 'upload'; // 'upload' or 'url'
    
    // DOM elements
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('fileInput');
    const uploadContainer = document.getElementById('upload-container');
    const uploadProgress = document.getElementById('upload-progress');
    const uploadProgressBar = document.querySelector('#upload-progress .progress-bar');
    const uploadStatus = document.getElementById('upload-status');
    const previewContainer = document.querySelector('.preview-container');
    const previewVideo = document.getElementById('preview-video');
    const urlPreview = document.getElementById('url-preview');
    const urlPreviewText = document.getElementById('url-preview-text');
    const processBtn = document.getElementById('process-btn');
    const processingStatus = document.getElementById('processing-status');
    const processingProgressBar = document.getElementById('processing-progress-bar');
    const processingStep = document.getElementById('processing-step');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const retryBtn = document.getElementById('retry-btn');
    const ratioOptions = document.querySelectorAll('.ratio-option');
    const videoUrlInput = document.getElementById('videoUrl');
    const urlSubmitBtn = document.getElementById('url-submit-btn');
    
    // Metrics tracking
    let processingStartTime = null;
    let processingStages = {
        download: { start: null, end: null },
        detection: { start: null, end: null },
        cropping: { start: null, end: null }
    };
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop area when drag over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    // Remove highlight when drag leave
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    // Handle dropped files
    dropArea.addEventListener('drop', handleDrop, false);
    
    // Handle file input change
    fileInput.addEventListener('change', handleFiles, false);
    
    // Handle URL submit button
    urlSubmitBtn.addEventListener('click', handleUrlSubmit, false);
    
    // Handle aspect ratio selection
    ratioOptions.forEach(option => {
        option.addEventListener('click', () => {
            ratioOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            selectedRatio = option.getAttribute('data-ratio');
        });
    });
    
    // Process button click
    processBtn.addEventListener('click', processVideo);
    
    // Retry button click
    retryBtn.addEventListener('click', () => {
        errorMessage.style.display = 'none';
        uploadContainer.style.display = 'block';
    });
    
    // Don't restore metrics panel on page load for index page
    document.addEventListener('DOMContentLoaded', function() {
        // Clear previous metrics state when loading the upload page
        localStorage.setItem('metricsVisible', 'false');
        
        // Check for minimize preference and apply it to the minize button icon
        const metricsMinimized = localStorage.getItem('metricsMinimized') === 'true';
        if (metricsMinimized) {
            const minimizeBtn = document.querySelector('.metrics-minimize i');
            if (minimizeBtn) {
                minimizeBtn.classList.remove('fa-minus');
                minimizeBtn.classList.add('fa-plus');
            }
        }
    });

    // Setup tabs to change video source
    document.getElementById('upload-tab').addEventListener('click', () => {
        videoSource = 'upload';
        urlPreview.style.display = 'none';
        if (selectedFile) {
            previewVideo.style.display = 'block';
        } else {
            previewContainer.style.display = 'none';
        }
    });
    
    document.getElementById('url-tab').addEventListener('click', () => {
        videoSource = 'url';
        if (videoUrl) {
            previewVideo.style.display = 'none';
            urlPreview.style.display = 'block';
            previewContainer.style.display = 'block';
            urlPreviewText.textContent = `URL: ${videoUrl}`;
        } else {
            previewContainer.style.display = 'none';
        }
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight() {
        dropArea.classList.add('highlight');
    }
    
    function unhighlight() {
        dropArea.classList.remove('highlight');
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles({ target: { files } });
    }
    
    function handleFiles(e) {
        const files = e.target.files;
        if (files.length) {
            selectedFile = files[0];
            videoSource = 'upload';
            videoUrl = null;
            
            // Check file type
            const fileType = selectedFile.type;
            if (!fileType.startsWith('video/')) {
                alert('Please select a video file.');
                return;
            }
            
            // Preview the video
            previewVideo.src = URL.createObjectURL(selectedFile);
            previewVideo.style.display = 'block';
            urlPreview.style.display = 'none';
            previewContainer.style.display = 'block';
            
            // Scroll to preview
            previewContainer.scrollIntoView({ behavior: 'smooth' });
            
            // Switch to upload tab
            document.getElementById('upload-tab').click();
        }
    }
    
    function handleUrlSubmit() {
        videoUrl = videoUrlInput.value.trim();
        
        if (!videoUrl) {
            alert('Please enter a valid URL.');
            return;
        }
        
        // Clear any file that was selected
        selectedFile = null;
        videoSource = 'url';
        
        // Update the preview
        previewVideo.style.display = 'none';
        urlPreview.style.display = 'block';
        urlPreviewText.textContent = `URL: ${videoUrl}`;
        previewContainer.style.display = 'block';
        
        // Scroll to preview
        previewContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    function processVideo() {
        if (videoSource === 'upload') {
            if (!selectedFile) {
                alert('Please select a video file first.');
                return;
            }
            
            // Start metrics tracking
            processingStartTime = Date.now();
            resetProcessingStages();
            showMetricsPanel();
            detectSystemInfo();
            
            uploadVideoFile();
        } else if (videoSource === 'url') {
            if (!videoUrl) {
                alert('Please enter a video URL first.');
                return;
            }
            
            // Start metrics tracking
            processingStartTime = Date.now();
            resetProcessingStages();
            showMetricsPanel();
            detectSystemInfo();
            
            processVideoUrl();
        }
    }
    
    function uploadVideoFile() {
        // Show upload progress
        uploadContainer.style.display = 'none';
        uploadProgress.style.display = 'block';
        uploadProgressBar.style.width = '0%';
        uploadStatus.textContent = 'Uploading...';
        
        // Create form data
        const formData = new FormData();
        formData.append('video', selectedFile);
        formData.append('aspect_ratio', selectedRatio);
        
        // Upload the file
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                uploadProgressBar.style.width = percentComplete + '%';
            }
        });
        
        xhr.addEventListener('readystatechange', function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    currentTaskId = response.task_id;
                    
                    // Start processing
                    startProcessing();
                } else {
                    showError('Error uploading the video. Please try again.');
                }
            }
        });
        
        xhr.open('POST', '/upload', true);
        xhr.send(formData);
    }
    
    function processVideoUrl() {
        // Show processing directly
        uploadContainer.style.display = 'none';
        processingStatus.style.display = 'block';
        processingProgressBar.style.width = '0%';
        processingStep.textContent = 'Preparing to process video URL...';
        
        // Update metrics panel
        updateProcessingStatus('Downloading video from URL');
        startProcessingStage('download');
        
        // Send the URL to the server
        fetch('/process_url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_url: videoUrl,
                aspect_ratio: selectedRatio
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                return;
            }
            
            currentTaskId = data.task_id;
            processingStatusInterval = setInterval(checkProcessingStatus, 1000);
        })
        .catch(error => {
            showError('Error processing the video URL. Please try again.');
        });
    }
    
    function startProcessing() {
        // Hide upload progress
        uploadProgress.style.display = 'none';
        
        // Show processing status
        processingStatus.style.display = 'block';
        processingProgressBar.style.width = '0%';
        processingStep.textContent = 'Initializing...';
        
        // Update metrics panel
        updateProcessingStatus('Starting processing');
        startProcessingStage('download');
        
        // Send request to start processing
        fetch(`/process/${currentTaskId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            // Start checking status
            processingStatusInterval = setInterval(checkProcessingStatus, 1000);
        })
        .catch(error => {
            showError('Error starting the processing. Please try again.');
        });
    }
    
    function checkProcessingStatus() {
        fetch(`/status/${currentTaskId}`)
        .then(response => response.json())
        .then(data => {
            updateProcessingUI(data);
            
            if (data.status === 'completed') {
                // Processing completed
                clearInterval(processingStatusInterval);
                endProcessingStage('cropping');
                updateProcessingStatus('Processing complete');
                updateTotalProcessingTime();
                
                // Redirect after a brief delay to show completed metrics
                setTimeout(() => {
                    window.location.href = `/result/${currentTaskId}`;
                }, 1500);
            } else if (data.status === 'error') {
                // Processing error
                clearInterval(processingStatusInterval);
                updateProcessingStatus('Error occurred');
                showError(data.error || 'An error occurred during processing.');
            }
        })
        .catch(error => {
            clearInterval(processingStatusInterval);
            showError('Error checking processing status. Please try again.');
        });
    }
    
    function updateProcessingUI(data) {
        processingProgressBar.style.width = data.progress + '%';
        
        if (data.progress < 30) {
            processingStep.textContent = 'Downloading and preparing video...';
            updateProcessingStatus('Downloading video');
        } else if (data.progress < 70) {
            processingStep.textContent = 'Detecting and analyzing speakers...';
            // If we're transitioning to detection stage
            if (processingStages.download.end === null) {
                endProcessingStage('download');
                startProcessingStage('detection');
                updateProcessingStatus('Detecting speakers');
            }
        } else {
            processingStep.textContent = 'Generating smart-cropped video...';
            // If we're transitioning to cropping stage
            if (processingStages.detection.end === null) {
                endProcessingStage('detection');
                startProcessingStage('cropping');
                updateProcessingStatus('Generating cropped video');
            }
        }
        
        // Update logs if available
        if (data.logs && data.logs.length > 0) {
            updateProcessingLogs(data.logs);
        }
        
        // Update system info if available
        if (data.system_info) {
            // Update device platform if available
            if (data.system_info.platform) {
                document.getElementById('platformInfo').textContent = 
                    `${getPlatformInfo()} | Server: ${data.system_info.platform}`;
            }
            
            // Update memory usage with real data
            if (data.system_info.memory_usage) {
                updateRealMemoryUsage(data.system_info.memory_usage);
            } else {
                updateSimulatedMemoryUsage(data.progress);
            }
        } else {
            // Fallback to simulated data
            updateSimulatedMemoryUsage(data.progress);
        }
    }
    
    function updateProcessingLogs(logs) {
        const logsContainer = document.getElementById('processingLogs');
        
        // Clear placeholder if present
        const placeholder = logsContainer.querySelector('.empty-log');
        if (placeholder) {
            logsContainer.innerHTML = '';
        }
        
        // Add new logs if they don't already exist
        logs.forEach(log => {
            const logId = `log-${log.timestamp.replace(/[\s:,\.]/g, '-')}`;
            if (!document.getElementById(logId)) {
                const logEntry = document.createElement('div');
                logEntry.id = logId;
                logEntry.className = 'log-entry';
                
                const timestamp = document.createElement('span');
                timestamp.className = 'timestamp';
                timestamp.textContent = log.timestamp.split(' ')[1]; // Show only time part
                
                const level = document.createElement('span');
                level.className = 'level';
                level.textContent = log.level;
                
                const message = document.createElement('span');
                message.className = 'message';
                message.textContent = log.message;
                
                logEntry.appendChild(timestamp);
                logEntry.appendChild(level);
                logEntry.appendChild(message);
                
                logsContainer.appendChild(logEntry);
            }
        });
        
        // Scroll to bottom to show latest logs
        logsContainer.scrollTop = logsContainer.scrollHeight;
        
        // Store logs in processingMetrics for result page
        storeProcessingLogs(logs);
    }
    
    function updateRealMemoryUsage(memoryData) {
        const rss = memoryData.rss || 0;
        const totalMemory = memoryData.total_system || 8192; // Default to 8GB if not available
        const memoryPercent = memoryData.percent || (rss / totalMemory * 100);
        
        // Update display
        document.getElementById('memoryUsed').textContent = `${Math.round(rss)} MB (${memoryPercent.toFixed(1)}%)`;
        document.getElementById('memoryFill').style.width = `${Math.min(100, memoryPercent)}%`;
    }
    
    function updateSimulatedMemoryUsage(progress) {
        // This is a simulation since we can't directly access server memory
        // In a real implementation, we would get this data from the server
        const baseMemory = 200; // MB base memory
        const maxMemory = 2048; // MB max memory
        
        let memoryUsage;
        if (progress < 30) {
            // During download phase
            memoryUsage = baseMemory + (progress / 100) * 300;
        } else if (progress < 70) {
            // During detection phase (highest memory usage)
            memoryUsage = baseMemory + 300 + ((progress - 30) / 40) * 1000;
        } else {
            // During cropping phase (decreasing)
            memoryUsage = baseMemory + 1300 - ((progress - 70) / 30) * 300;
        }
        
        // Add some random fluctuation
        memoryUsage += Math.random() * 100 - 50;
        memoryUsage = Math.max(baseMemory, Math.min(maxMemory, memoryUsage));
        
        // Update display
        document.getElementById('memoryUsed').textContent = `${Math.round(memoryUsage)} MB (Simulated)`;
        document.getElementById('memoryFill').style.width = `${(memoryUsage / maxMemory) * 100}%`;
    }
    
    function showError(message) {
        processingStatus.style.display = 'none';
        uploadProgress.style.display = 'none';
        errorMessage.style.display = 'block';
        errorText.textContent = message;
        
        if (processingStatusInterval) {
            clearInterval(processingStatusInterval);
        }
        
        // Update metrics panel
        updateProcessingStatus('Error: ' + message);
    }
    
    // Metrics Panel Functions
    function showMetricsPanel() {
        const panel = document.getElementById('metricsPanel');
        panel.classList.add('active');
        localStorage.setItem('metricsVisible', 'true');
        
        // Apply minimized state if previously minimized
        const metricsMinimized = localStorage.getItem('metricsMinimized') === 'true';
        if (metricsMinimized) {
            panel.classList.add('minimized');
            const minimizeBtn = panel.querySelector('.metrics-minimize i');
            if (minimizeBtn) {
                minimizeBtn.classList.remove('fa-minus');
                minimizeBtn.classList.add('fa-plus');
            }
        }
    }
    
    function detectSystemInfo() {
        // Get device type
        const deviceType = getDeviceType();
        document.getElementById('deviceType').textContent = deviceType;
        
        // Get platform info
        const platformInfo = getPlatformInfo();
        document.getElementById('platformInfo').textContent = platformInfo;
    }
    
    function getDeviceType() {
        const ua = navigator.userAgent;
        if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
            return "Tablet";
        }
        if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
            return "Mobile";
        }
        return "Desktop";
    }
    
    function getPlatformInfo() {
        const ua = navigator.userAgent;
        let platform = navigator.platform || "Unknown";
        
        // Check for CPU
        const cpuClass = navigator.cpuClass || "";
        const cpuInfo = cpuClass ? ` (${cpuClass})` : "";
        
        // Check for OS
        let os = "Unknown OS";
        if (ua.indexOf("Win") !== -1) os = "Windows";
        else if (ua.indexOf("Mac") !== -1) os = "MacOS";
        else if (ua.indexOf("Linux") !== -1) os = "Linux";
        else if (ua.indexOf("Android") !== -1) os = "Android";
        else if (ua.indexOf("iOS") !== -1) os = "iOS";
        
        return `${os} on ${platform}${cpuInfo}`;
    }
    
    function updateProcessingStatus(status) {
        const statusElement = document.getElementById('processingStatus');
        statusElement.textContent = status;
    }
    
    function resetProcessingStages() {
        processingStages = {
            download: { start: null, end: null },
            detection: { start: null, end: null },
            cropping: { start: null, end: null }
        };
        
        // Reset display
        document.getElementById('downloadTime').textContent = '--';
        document.getElementById('detectionTime').textContent = '--';
        document.getElementById('croppingTime').textContent = '--';
        document.getElementById('totalTime').textContent = '--';
    }
    
    function startProcessingStage(stage) {
        if (processingStages[stage]) {
            processingStages[stage].start = Date.now();
        }
    }
    
    function endProcessingStage(stage) {
        if (processingStages[stage] && processingStages[stage].start) {
            processingStages[stage].end = Date.now();
            const duration = (processingStages[stage].end - processingStages[stage].start) / 1000;
            document.getElementById(`${stage}Time`).textContent = `${duration.toFixed(2)}s`;
        }
    }
    
    function updateTotalProcessingTime() {
        if (processingStartTime) {
            const totalDuration = (Date.now() - processingStartTime) / 1000;
            document.getElementById('totalTime').textContent = `${totalDuration.toFixed(2)}s`;
            
            // Store the metrics data for the result page
            storeProcessingMetrics();
        }
    }
    
    function storeProcessingMetrics() {
        // Store all the metrics in localStorage for access on the result page
        const metricsData = {
            downloadTime: document.getElementById('downloadTime').textContent,
            detectionTime: document.getElementById('detectionTime').textContent,
            croppingTime: document.getElementById('croppingTime').textContent,
            totalTime: document.getElementById('totalTime').textContent,
            deviceType: document.getElementById('deviceType').textContent,
            platformInfo: document.getElementById('platformInfo').textContent,
            memoryUsed: document.getElementById('memoryUsed').textContent,
            logs: JSON.parse(localStorage.getItem('processingLogs') || '[]')
        };
        
        localStorage.setItem('processingMetrics', JSON.stringify(metricsData));
    }
    
    function storeProcessingLogs(logs) {
        // Store logs in localStorage
        localStorage.setItem('processingLogs', JSON.stringify(logs));
    }
</script>
{% endblock %} 