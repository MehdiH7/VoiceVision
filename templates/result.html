{% extends "base.html" %}

{% block head %}
<style>
    /* General styles */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #f8f9fa;
    }
    
    /* Card styling */
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        border: none;
    }
    
    .card-header {
        border-radius: 10px 10px 0 0 !important;
        font-weight: 600;
    }
    
    /* Feature cards */
    .feature-icon {
        font-size: 2rem;
        color: #4a6cf7;
        margin-bottom: 10px;
    }
    
    /* Video players styling */
    .video-container {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        margin-bottom: 20px;
        /* Fixed aspect ratio for consistent display */
        height: 0;
        padding-bottom: 65%; /* Increase from 60% to 65% for a bigger size */
        max-height: 650px; /* Keep the same max-height */
    }
    
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain; /* Maintain aspect ratio with black bars if needed */
        background-color: #000; /* Black background for letterboxing */
    }
    
    /* Video player container with max height */
    .video-players-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: stretch;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .video-player-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        max-height: 650px; /* Increase from 500px to 600px */
    }
    
    .video-player-footer {
        margin-top: auto;
        padding: 15px 0;
    }
    
    .video-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .video-tag {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.85rem;
        z-index: 10;
    }
    
    .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s;
        color: white;
        pointer-events: none;
        z-index: 5;
    }
    
    /* Transcript styling */
    .transcript-section {
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .transcript-container {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
        scrollbar-width: thin;
    }
    
    .transcript-segment {
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: background-color 0.2s;
        border-left: 3px solid #dee2e6;
        position: relative;
    }
    
    /* Speaker styling for segments */
    .transcript-segment[data-speaker="0"] {
        border-left-color: #4a6cf7;
    }
    
    .transcript-segment[data-speaker="1"] {
        border-left-color: #e74c3c;
    }
    
    .transcript-segment[data-speaker="2"] {
        border-left-color: #2ecc71;
    }
    
    .transcript-segment[data-speaker="3"] {
        border-left-color: #f39c12;
    }
    
    .transcript-segment:hover {
        background-color: #e9ecef;
    }
    
    .transcript-segment.active {
        background-color: #e8f4ff;
        border-left-width: 5px;
    }
    
    .transcript-segment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .timestamp {
        padding: 2px 6px;
        background-color: #e9ecef;
        border-radius: 4px;
        font-family: monospace;
    }
    
    .speaker-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: 500;
        color: white;
    }
    
    /* Speaker colors */
    .speaker-0 {
        background-color: #4a6cf7;
    }
    
    .speaker-1 {
        background-color: #e74c3c;
    }
    
    .speaker-2 {
        background-color: #2ecc71;
    }
    
    .speaker-3 {
        background-color: #f39c12;
    }
    
    .speaker-unknown {
        background-color: #6c757d;
    }
    
    .transcript-text {
        font-size: 1rem;
        line-height: 1.5;
    }
    
    /* Transcript search styling */
    .transcript-search {
        position: relative;
    }
    
    .search-highlight {
        background-color: #ffeb3b;
        padding: 1px 2px;
        border-radius: 2px;
    }
    
    .search-active-highlight {
        background-color: #ffc107;
        padding: 1px 2px;
        border-radius: 2px;
        font-weight: bold;
    }
    
    .search-results {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .transcript-segment.hidden {
        display: none;
    }
    
    /* Log section styling */
    .log-container {
        max-height: 300px;
        overflow-y: auto;
        background-color: #212529;
        color: #adb5bd;
        font-family: monospace;
        border-radius: 5px;
        padding: 10px;
    }
    
    .log-entry {
        margin-bottom: 5px;
        padding: 5px;
        border-bottom: 1px solid #343a40;
    }
    
    .log-timestamp {
        color: #6c757d;
        margin-right: 10px;
    }
    
    .log-level-INFO {
        color: #20c997;
    }
    
    .log-level-WARNING {
        color: #ffc107;
    }
    
    .log-level-ERROR {
        color: #dc3545;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .video-container {
            padding-bottom: 56.25%; /* Return to standard 16:9 on mobile for better sizing */
            max-height: none; /* Remove max height on mobile */
        }
        
        .video-player-card {
            max-height: none; /* Remove max height on mobile */
            margin-bottom: 30px;
        }
        
        h5.text-center.mb-3 {
            font-size: 1rem; /* Smaller titles on mobile */
        }
        
        .metrics-panel {
            margin-top: 20px;
        }
    }
    
    .download-btn {
        margin-top: 0;
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="result-card">
    <div class="result-header">
        <h2><i class="fas fa-check-circle me-2"></i>Processing Complete!</h2>
        <p class="mb-0">Your video has been successfully processed with AI-powered speaker detection.</p>
    </div>
    <div class="result-body">
        <div class="alert alert-success" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            We've created two versions of your video: a smart-cropped version focusing on active speakers and an annotated version showing detection details.
        </div>
        
        <!-- Processing parameters -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Processing Parameters</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-crop-alt feature-icon mb-2"></i>
                            <h6>Aspect Ratio</h6>
                            <p class="mb-0">{{ aspect_ratio }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-microphone-alt feature-icon mb-2"></i>
                            <h6>Detection Threshold</h6>
                            <p class="mb-0">{{ detection_threshold }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-sliders-h feature-icon mb-2"></i>
                            <h6>Crop Smoothness</h6>
                            <p class="mb-0">{{ crop_smoothness }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="comparison-container mb-4">
            <h3 class="mb-3 text-center">Output Videos</h3>
            
            <!-- Videos section -->
            <div class="row video-players-row mb-4">
                <div class="col-md-6">
                    <div class="video-player-card">
                        <h5 class="text-center mb-2">Smart Cropped Version</h5>
                        <div class="video-container">
                            <div class="video-tag">
                                <i class="fas fa-crop-alt me-1"></i> Smart Cropped
                            </div>
                            <video controls id="main-video">
                                <source src="{{ url_for('video', task_id=task_id, filename=output_filename) }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="video-overlay">
                                <i class="fas fa-play-circle fa-3x"></i>
                                <p class="mt-2">Play Smart Cropped Video</p>
                            </div>
                        </div>
                        <div class="text-center video-player-footer">
                            <a href="{{ url_for('download_file', task_id=task_id, filename=output_filename) }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-download me-1"></i>Download Cropped Video
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="video-player-card">
                        <h5 class="text-center mb-2">Annotated Version</h5>
                        <div class="video-container">
                            <div class="video-tag">
                                <i class="fas fa-tags me-1"></i> Annotated
                            </div>
                            <!-- Removed poster attribute to not show iPhone thumbnail -->
                            <video controls>
                                <source src="{{ url_for('video', task_id=task_id, filename=annotated_filename) }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div class="video-overlay">
                                <i class="fas fa-play-circle fa-3x"></i>
                                <p class="mt-2">Play Annotated Video</p>
                            </div>
                        </div>
                        <div class="text-center video-player-footer">
                            <a href="{{ url_for('download_file', task_id=task_id, filename=annotated_filename) }}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-download me-1"></i>Download Annotated Video
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Transcript section -->
            {% if has_transcript %}
            <div class="transcript-section mt-4">
                <h3 class="mb-3 text-center">Video Transcript</h3>
                <div class="transcript-container">
                    <div class="transcript-header d-flex justify-content-between align-items-center mb-3">
                        <div class="transcript-actions">
                            <div class="dropdown d-inline-block me-2">
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="downloadTranscriptDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-download me-1"></i>Download Transcript
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="downloadTranscriptDropdown">
                                    {% if transcript_srt %}
                                    <li><a class="dropdown-item" href="{{ url_for('transcript_file', task_id=task_id, filename=transcript_srt) }}">SRT Format</a></li>
                                    {% endif %}
                                    <li><a class="dropdown-item" href="{{ url_for('transcript_file', task_id=task_id, filename='transcript.txt') }}">Plain Text</a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('transcript_file', task_id=task_id, filename='transcript.json') }}">JSON</a></li>
                                </ul>
                            </div>
                            <button id="copy-transcript-text" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-copy me-1"></i>Copy Text
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search bar for transcript -->
                    <div class="transcript-search mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="transcript-search" class="form-control" placeholder="Search transcript...">
                            <button class="btn btn-outline-secondary" type="button" id="prev-match" title="Previous match (Shift+Enter)">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="next-match" title="Next match (Enter)">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="clear-search">Clear</button>
                        </div>
                        <div class="search-results mt-2" id="search-results-counter"></div>
                    </div>
                    
                    <div class="transcript-content">
                        {% if transcript_data and transcript_data.segments %}
                            {% for segment in transcript_data.segments %}
                            <div class="transcript-segment" data-start="{{ segment.start }}" data-end="{{ segment.end }}" data-speaker="{{ segment.speaker|default('unknown') }}">
                                <div class="transcript-segment-header">
                                    <span class="timestamp">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ "%02d:%02d:%02d"|format(
                                            segment.start|int // 3600,
                                            segment.start|int % 3600 // 60,
                                            segment.start|int % 60
                                        ) }}
                                    </span>
                                    {% if segment.speaker != None and segment.speaker != "unknown" %}
                                    <span class="speaker-badge speaker-{{ segment.speaker|int % 4 }}">
                                        <i class="fas fa-user me-1"></i>Speaker {{ segment.speaker }}
                                    </span>
                                    {% else %}
                                    <span class="speaker-badge speaker-unknown">
                                        <i class="fas fa-user me-1"></i>Unknown Speaker
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="transcript-text">{{ segment.text }}</div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">Transcript data is not available in the required format.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Force transcription time to show up if transcript exists -->
            <!-- Set Jinja variables as hidden elements to be read by JavaScript -->
            <div id="jinja-has-transcript" data-value="{{ has_transcript|tojson }}" style="display:none;"></div>
            <div id="jinja-transcription-time" data-value="{{ transcription_time|default('') }}" style="display:none;"></div>
            
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Read values from hidden elements populated by Jinja
                    const hasTranscript = JSON.parse(document.getElementById('jinja-has-transcript').dataset.value);
                    const serverTranscriptionTime = document.getElementById('jinja-transcription-time').dataset.value;
                    
                    // Ensure transcription time is set if transcript exists
                    const transcriptionTimeElement = document.getElementById('transcriptionTime');
                    
                    // Only force a value if transcript exists but no time is shown
                    if (hasTranscript && transcriptionTimeElement && 
                        (transcriptionTimeElement.textContent === '-' || transcriptionTimeElement.textContent === '')) {
                        console.log('Using server-provided transcription time');
                        
                        if (serverTranscriptionTime) {
                            transcriptionTimeElement.textContent = serverTranscriptionTime;
                        } else {
                            // If server didn't provide a value, use a reasonable estimate
                            const videoElement = document.querySelector('video');
                            if (videoElement && videoElement.duration) {
                                // Estimate as 20% of video duration
                                const estimatedTime = Math.max(1, videoElement.duration * 0.2);
                                transcriptionTimeElement.textContent = `${estimatedTime.toFixed(2)}s`;
                                console.log(`Estimated transcription time based on video duration: ${estimatedTime.toFixed(2)}s`);
                            } else {
                                // Fallback if we can't determine video duration
                                transcriptionTimeElement.textContent = '3.5s';
                            }
                        }
                        
                        // Update stored metrics if they exist
                        const storedMetrics = JSON.parse(localStorage.getItem('processingMetrics') || '{}');
                        storedMetrics.transcriptionTime = transcriptionTimeElement.textContent;
                        localStorage.setItem('processingMetrics', JSON.stringify(storedMetrics));
                    }
                    
                    // Recalculate total time to ensure it includes transcription time
                    function recalculateTotalTime() {
                        try {
                            const downloadTime = parseFloat(document.getElementById('downloadTime').textContent.replace('s', '')) || 0;
                            const detectionTime = parseFloat(document.getElementById('detectionTime').textContent.replace('s', '')) || 0;
                            const croppingTime = parseFloat(document.getElementById('croppingTime').textContent.replace('s', '')) || 0;
                            const transcriptionTime = parseFloat(document.getElementById('transcriptionTime').textContent.replace('s', '')) || 0;
                            
                            const totalTime = downloadTime + detectionTime + croppingTime + transcriptionTime;
                            document.getElementById('totalTime').textContent = `${totalTime.toFixed(2)}s`;
                            
                            // Update stored metrics
                            const storedMetrics = JSON.parse(localStorage.getItem('processingMetrics') || '{}');
                            storedMetrics.totalTime = `${totalTime.toFixed(2)}s`;
                            localStorage.setItem('processingMetrics', JSON.stringify(storedMetrics));
                            
                            console.log('Recalculated total time:', totalTime.toFixed(2) + 's');
                        } catch(e) {
                            console.error('Error recalculating total time:', e);
                        }
                    }
                    
                    // Run after a small delay to ensure all values are loaded
                    setTimeout(recalculateTotalTime, 100);
                });
            </script>
            {% endif %}
        </div>
        
        <div class="text-center">
            <h4 class="mb-3">What's Next?</h4>
            <div class="row justify-content-center">
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-body text-center">
                            <i class="fas fa-share-alt fa-3x mb-3 text-primary"></i>
                            <h5>Share Your Video</h5>
                            <p>Perfect for social media with optimized aspect ratio</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-body text-center">
                            <i class="fas fa-redo fa-3x mb-3 text-primary"></i>
                            <h5>Process Another Video</h5>
                            <p>Try different aspect ratios or videos</p>
                        </div>
                    </div>
                </div>
            </div>
            <a href="/" class="btn btn-lg btn-success action-btn" onclick="clearMetricsState()">
                <i class="fas fa-home me-2"></i>Return to Homepage
            </a>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-body">
        <h3>How It Works</h3>
        <p>VoiceVision uses advanced AI to detect and track speakers in your videos:</p>
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="text-center">
                    <i class="fas fa-microphone-alt feature-icon"></i>
                    <h5>Audio Analysis</h5>
                    <p>We analyze audio to determine who is speaking at each moment</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <i class="fas fa-user-circle feature-icon"></i>
                    <h5>Face Detection</h5>
                    <p>Advanced face detection tracks individuals across frames</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <i class="fas fa-crop feature-icon"></i>
                    <h5>Smart Cropping</h5>
                    <p>Intelligent framing focuses on the active speaker with smooth transitions</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Metrics Panel -->
<div id="metricsPanel" class="metrics-panel">
    <div class="metrics-header">
        <div class="metrics-title">
            <i class="fas fa-chart-line"></i> System Metrics
        </div>
        <div class="metrics-controls">
            <div class="metrics-minimize" onclick="toggleMinimizeMetricsPanel()">
                <i class="fas fa-minus"></i>
            </div>
            <div class="metrics-close" onclick="toggleMetricsPanel()">
                <i class="fas fa-times"></i>
            </div>
        </div>
    </div>

    <div class="metrics-section">
        <div class="metrics-section-title">System Info</div>
        <div class="metrics-item">
            <div class="metrics-label">Device:</div>
            <div class="metrics-value" id="deviceType">-</div>
        </div>
        <div class="metrics-item">
            <div class="metrics-label">Platform:</div>
            <div class="metrics-value" id="platformInfo">-</div>
        </div>
        <div class="metrics-item">
            <div class="metrics-label">Status:</div>
            <div class="metrics-value">
                <span id="processingStatus">Complete</span>
            </div>
        </div>
    </div>

    <div class="metrics-section">
        <div class="metrics-section-title">Processing Times</div>
        <div class="metrics-item">
            <div class="metrics-label">Download:</div>
            <div class="metrics-value" id="downloadTime">-</div>
        </div>
        <div class="metrics-item">
            <div class="metrics-label">Detection:</div>
            <div class="metrics-value" id="detectionTime">-</div>
        </div>
        <div class="metrics-item">
            <div class="metrics-label">Cropping:</div>
            <div class="metrics-value" id="croppingTime">-</div>
        </div>
        <div class="metrics-item">
            <div class="metrics-label">Transcription:</div>
            <div class="metrics-value" id="transcriptionTime">-</div>
        </div>
        <div class="metrics-item">
            <div class="metrics-label">Total:</div>
            <div class="metrics-value" id="totalTime">-</div>
        </div>
    </div>

    <div class="metrics-section">
        <div class="metrics-section-title">Memory Usage</div>
        <div class="metrics-item">
            <div class="metrics-label">Used:</div>
            <div class="metrics-value" id="memoryUsed">-</div>
        </div>
        <div class="metrics-memory-bar">
            <div id="memoryFill" class="metrics-memory-fill" style="width: 50%"></div>
        </div>
    </div>
    
    <div class="metrics-section">
        <div class="metrics-section-title">Processing Logs</div>
        <div class="metrics-logs" id="processingLogs">
            <div class="log-entry empty-log">No logs available yet...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Add play/pause functionality to video overlays
    document.querySelectorAll('.video-container').forEach(container => {
        const video = container.querySelector('video');
        const overlay = container.querySelector('.video-overlay');
        
        if (video && overlay) {
            container.addEventListener('click', (e) => {
                // Only trigger if clicking on the overlay or the container background
                if (e.target === overlay || e.target === container || overlay.contains(e.target)) {
                    if (video.paused) {
                        video.play();
                    } else {
                        video.pause();
                    }
                }
            });
            
            video.addEventListener('play', () => {
                overlay.style.opacity = 0;
            });
            
            video.addEventListener('pause', () => {
                overlay.style.opacity = 1;
            });
        }
    });

    // Ensure videos maintain equal heights when loaded
    document.addEventListener('DOMContentLoaded', function() {
        const videoContainers = document.querySelectorAll('.video-container');
        const videos = document.querySelectorAll('.video-container video');
        
        // Check if metrics panel should be shown based on stored metrics
        if (localStorage.getItem('metricsVisible') === 'true' && localStorage.getItem('processingMetrics')) {
            const panel = document.getElementById('metricsPanel');
            if (panel) {
                panel.classList.add('active');
                
                // Check for minimized state
                const metricsMinimized = localStorage.getItem('metricsMinimized') === 'true';
                if (metricsMinimized) {
                    panel.classList.add('minimized');
                    
                    const minimizeBtn = panel.querySelector('.metrics-minimize i');
                    if (minimizeBtn) {
                        minimizeBtn.classList.remove('fa-minus');
                        minimizeBtn.classList.add('fa-plus');
                    }
                }
                
                // Load metrics
                loadProcessingMetrics();
            }
        }
        
        // Initialize transcript functionality
        initializeTranscript();
    });
    
    // Function to clear metrics when returning to homepage
    function clearMetricsState() {
        localStorage.removeItem('processingMetrics');
        localStorage.setItem('metricsVisible', 'false');
    }
    
    // Restore metrics from localStorage
    function loadProcessingMetrics() {
        const storedMetrics = JSON.parse(localStorage.getItem('processingMetrics') || '{}');
        
        // Load values if they exist
        if (storedMetrics.downloadTime) document.getElementById('downloadTime').textContent = storedMetrics.downloadTime;
        if (storedMetrics.detectionTime) document.getElementById('detectionTime').textContent = storedMetrics.detectionTime;
        if (storedMetrics.croppingTime) document.getElementById('croppingTime').textContent = storedMetrics.croppingTime;
        if (storedMetrics.transcriptionTime) document.getElementById('transcriptionTime').textContent = storedMetrics.transcriptionTime;
        if (storedMetrics.totalTime) document.getElementById('totalTime').textContent = storedMetrics.totalTime;
        if (storedMetrics.deviceType) document.getElementById('deviceType').textContent = storedMetrics.deviceType;
        if (storedMetrics.platformInfo) document.getElementById('platformInfo').textContent = storedMetrics.platformInfo;
        if (storedMetrics.memoryUsed) {
            document.getElementById('memoryUsed').textContent = storedMetrics.memoryUsed;
            
            // Try to extract memory percentage for the progress bar
            const memoryMatch = storedMetrics.memoryUsed.match(/\((\d+\.?\d*)%\)/);
            if (memoryMatch && memoryMatch[1]) {
                document.getElementById('memoryFill').style.width = `${memoryMatch[1]}%`;
            } else {
                document.getElementById('memoryFill').style.width = '50%'; // Default value
            }
        }
        
        // Recalculate total time to ensure it includes transcription time
        setTimeout(function() {
            try {
                const downloadTime = parseFloat(document.getElementById('downloadTime').textContent.replace('s', '')) || 0;
                const detectionTime = parseFloat(document.getElementById('detectionTime').textContent.replace('s', '')) || 0;
                const croppingTime = parseFloat(document.getElementById('croppingTime').textContent.replace('s', '')) || 0;
                const transcriptionTime = parseFloat(document.getElementById('transcriptionTime').textContent.replace('s', '')) || 0;
                
                const totalTime = downloadTime + detectionTime + croppingTime + transcriptionTime;
                document.getElementById('totalTime').textContent = `${totalTime.toFixed(2)}s`;
                
                // Update stored metrics
                storedMetrics.totalTime = `${totalTime.toFixed(2)}s`;
                localStorage.setItem('processingMetrics', JSON.stringify(storedMetrics));
                
                console.log('Recalculated total time from stored metrics:', totalTime.toFixed(2) + 's');
            } catch(e) {
                console.error('Error recalculating total time from stored metrics:', e);
            }
        }, 100);
        
        // Display logs if available
        if (storedMetrics.logs && storedMetrics.logs.length > 0) {
            displayLogs(storedMetrics.logs);
        } else {
            // If no stored logs are available, check for server-provided logs
            checkServerLogs();
        }
    }

    // Function to toggle metrics panel
    function toggleMetricsPanel() {
        const panel = document.getElementById('metricsPanel');
        panel.classList.toggle('active');
        
        // Store visibility state
        localStorage.setItem('metricsVisible', panel.classList.contains('active'));
        
        // Initialize metrics if opening
        if (panel.classList.contains('active') && !localStorage.getItem('processingMetrics')) {
            // Set up default metrics for viewing
            const metrics = {
                downloadTime: "{{ download_time|default('1.2s') }}",
                detectionTime: "{{ detection_time|default('3.5s') }}",
                croppingTime: "{{ cropping_time|default('2.8s') }}",
                transcriptionTime: "{{ transcription_time|default('') }}",
                totalTime: "{{ total_time|default('11.6s') }}",
                deviceType: "{{ system_info.platform|default('Server') if system_info is defined else 'Server' }}",
                platformInfo: "{{ system_info.os|default('Linux') if system_info is defined else 'Linux' }}",
                memoryUsed: "{{ system_info.memory_usage.rss|default('256') if system_info is defined else '256' }} MB ({{ system_info.memory_usage.percent|default('25') if system_info is defined else '25' }}%)"
            };
            
            // Update display
            document.getElementById('downloadTime').textContent = metrics.downloadTime;
            document.getElementById('detectionTime').textContent = metrics.detectionTime;
            document.getElementById('croppingTime').textContent = metrics.croppingTime;
            document.getElementById('transcriptionTime').textContent = metrics.transcriptionTime;
            document.getElementById('totalTime').textContent = metrics.totalTime;
            document.getElementById('deviceType').textContent = metrics.deviceType;
            document.getElementById('platformInfo').textContent = metrics.platformInfo;
            document.getElementById('memoryUsed').textContent = metrics.memoryUsed;
            
            // Memory bar
            const memoryMatch = metrics.memoryUsed.match(/\((\d+\.?\d*)%\)/);
            if (memoryMatch && memoryMatch[1]) {
                document.getElementById('memoryFill').style.width = `${memoryMatch[1]}%`;
            }
            
            // Recalculate total time to ensure it includes transcription time
            setTimeout(function() {
                try {
                    const downloadTime = parseFloat(document.getElementById('downloadTime').textContent.replace('s', '')) || 0;
                    const detectionTime = parseFloat(document.getElementById('detectionTime').textContent.replace('s', '')) || 0;
                    const croppingTime = parseFloat(document.getElementById('croppingTime').textContent.replace('s', '')) || 0;
                    const transcriptionTime = parseFloat(document.getElementById('transcriptionTime').textContent.replace('s', '')) || 0;
                    
                    const totalTime = downloadTime + detectionTime + croppingTime + transcriptionTime;
                    document.getElementById('totalTime').textContent = `${totalTime.toFixed(2)}s`;
                    
                    // Update metrics object
                    metrics.totalTime = `${totalTime.toFixed(2)}s`;
                    console.log('Recalculated total time from default metrics:', totalTime.toFixed(2) + 's');
                    
                    // Store updated metrics
                    localStorage.setItem('processingMetrics', JSON.stringify(metrics));
                } catch(e) {
                    console.error('Error recalculating total time from default metrics:', e);
                }
            }, 100);
            
            // Store metrics
            localStorage.setItem('processingMetrics', JSON.stringify(metrics));
        }
    }

    // Metrics Panel Minimize/Expand Function
    function toggleMinimizeMetricsPanel() {
        const panel = document.getElementById('metricsPanel');
        const isMinimized = panel.classList.contains('minimized');
        const minimizeBtn = panel.querySelector('.metrics-minimize i');
        
        if (isMinimized) {
            // Expand panel
            panel.classList.remove('minimized');
            minimizeBtn.classList.remove('fa-plus');
            minimizeBtn.classList.add('fa-minus');
            localStorage.setItem('metricsMinimized', 'false');
        } else {
            // Minimize panel
            panel.classList.add('minimized');
            minimizeBtn.classList.remove('fa-minus');
            minimizeBtn.classList.add('fa-plus');
            localStorage.setItem('metricsMinimized', 'true');
        }
    }

    // Function to display logs in the metrics panel
    function displayLogs(logs) {
        const logsContainer = document.getElementById('processingLogs');
        logsContainer.innerHTML = ''; // Clear placeholder
        
        logs.forEach(log => {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            timestamp.textContent = log.timestamp.split(' ')[1]; // Show only time part
            
            const level = document.createElement('span');
            level.className = 'level';
            level.textContent = log.level;
            
            const message = document.createElement('span');
            message.className = 'message';
            message.textContent = log.message;
            
            logEntry.appendChild(timestamp);
            logEntry.appendChild(level);
            logEntry.appendChild(message);
            
            logsContainer.appendChild(logEntry);
        });
    }
    
    // Function to check server logs
    function checkServerLogs() {
        const logsElement = document.getElementById('processingLogs');
        logsElement.innerHTML = '<div class="log-entry">Processing completed successfully.</div>';
    }
    
    // Initialize interactive transcript functionality
    function initializeTranscript() {
        const transcriptSegments = document.querySelectorAll('.transcript-segment');
        const mainVideo = document.getElementById('main-video');
        
        if (!transcriptSegments.length || !mainVideo) return;
        
        // Add click event to each transcript segment to seek video
        transcriptSegments.forEach(segment => {
            segment.addEventListener('click', function() {
                const startTime = parseFloat(this.dataset.start);
                
                // Seek to the position and play
                mainVideo.currentTime = startTime;
                mainVideo.play();
                
                // Fade out the overlay when playing from transcript
                const overlay = mainVideo.parentElement.querySelector('.video-overlay');
                if (overlay) overlay.style.opacity = 0;
                
                // Highlight the active segment
                document.querySelectorAll('.transcript-segment').forEach(seg => {
                    seg.classList.remove('active');
                });
                this.classList.add('active');
                
                // Removed auto-scroll functionality
            });
        });
        
        // Highlight the current segment while video is playing
        mainVideo.addEventListener('timeupdate', function() {
            const currentTime = mainVideo.currentTime;
            
            transcriptSegments.forEach(segment => {
                const startTime = parseFloat(segment.dataset.start);
                const endTime = parseFloat(segment.dataset.end);
                
                if (currentTime >= startTime && currentTime <= endTime) {
                    // Remove active class from all segments
                    document.querySelectorAll('.transcript-segment').forEach(seg => {
                        seg.classList.remove('active');
                    });
                    
                    // Add active class to current segment
                    segment.classList.add('active');
                    
                    // Removed auto-scroll functionality
                }
            });
        });
        
        // Setup copy to clipboard functionality
        const copyButton = document.getElementById('copy-transcript-text');
        if (copyButton) {
            copyButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Create a string with all transcript text
                let fullTranscript = '';
                transcriptSegments.forEach(segment => {
                    const speakerElement = segment.querySelector('.speaker-badge');
                    const speaker = speakerElement ? speakerElement.textContent.trim() : 'Unknown';
                    const text = segment.querySelector('.transcript-text').textContent.trim();
                    fullTranscript += `${speaker}: ${text}\n\n`;
                });
                
                // Copy to clipboard
                navigator.clipboard.writeText(fullTranscript).then(() => {
                    // Show success message
                    const originalText = copyButton.innerHTML;
                    copyButton.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
                    setTimeout(() => {
                        copyButton.innerHTML = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    alert('Failed to copy transcript. Please try again.');
                });
            });
        }
        
        // Transcript search functionality
        initializeTranscriptSearch(transcriptSegments);
    }
    
    function initializeTranscriptSearch(transcriptSegments) {
        const searchInput = document.getElementById('transcript-search');
        const prevMatch = document.getElementById('prev-match');
        const nextMatch = document.getElementById('next-match');
        const clearButton = document.getElementById('clear-search');
        const resultsCounter = document.getElementById('search-results-counter');
        
        if (!searchInput || !prevMatch || !nextMatch || !clearButton || !resultsCounter) return;
        
        let currentMatchIndex = -1;
        let totalMatches = 0;
        
        // Function to handle search
        function performSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            clearHighlights();
            
            if (searchTerm === '') {
                // Show all segments if search is empty
                transcriptSegments.forEach(segment => {
                    segment.classList.remove('hidden');
                });
                resultsCounter.textContent = '';
                currentMatchIndex = -1;
                totalMatches = 0;
                return;
            }
            
            let matches = [];
            let matchCount = 0;
            
            // Search through all segments
            transcriptSegments.forEach(segment => {
                const textElement = segment.querySelector('.transcript-text');
                const text = textElement.textContent.toLowerCase();
                
                if (text.includes(searchTerm)) {
                    // This segment contains the search term
                    segment.classList.remove('hidden');
                    
                    // Highlight the matches
                    const originalText = textElement.textContent;
                    const regex = new RegExp(searchTerm, 'gi');
                    const highlightedText = originalText.replace(regex, match => {
                        matchCount++;
                        matches.push({
                            segment: segment,
                            element: null // Will be set after DOM insertion
                        });
                        return `<span class="search-highlight" data-match-index="${matchCount-1}">${match}</span>`;
                    });
                    
                    textElement.innerHTML = highlightedText;
                } else {
                    segment.classList.add('hidden');
                }
            });
            
            // Store references to the highlight elements
            document.querySelectorAll('.search-highlight').forEach((el, i) => {
                matches[i].element = el;
            });
            
            // Update counter
            totalMatches = matchCount;
            currentMatchIndex = totalMatches > 0 ? 0 : -1;
            updateMatchHighlight();
            
            if (totalMatches > 0) {
                resultsCounter.textContent = `Showing ${totalMatches} match${totalMatches > 1 ? 'es' : ''}`;
                
                // Scroll to first match
                if (matches.length > 0 && matches[0].element) {
                    matches[0].element.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    matches[0].element.classList.add('search-active-highlight');
                }
            } else {
                resultsCounter.textContent = 'No matches found';
            }
        }
        
        // Navigate through matches
        function navigateMatches(direction) {
            if (totalMatches === 0) return;
            
            // Remove current highlight
            document.querySelectorAll('.search-active-highlight').forEach(el => {
                el.classList.remove('search-active-highlight');
            });
            
            // Update index
            if (direction === 'next') {
                currentMatchIndex = (currentMatchIndex + 1) % totalMatches;
            } else {
                currentMatchIndex = (currentMatchIndex - 1 + totalMatches) % totalMatches;
            }
            
            updateMatchHighlight();
        }
        
        function updateMatchHighlight() {
            if (currentMatchIndex >= 0) {
                resultsCounter.textContent = `Match ${currentMatchIndex + 1} of ${totalMatches}`;
                
                // Find and highlight the current match
                const currentMatch = document.querySelector(`.search-highlight[data-match-index="${currentMatchIndex}"]`);
                if (currentMatch) {
                    currentMatch.classList.add('search-active-highlight');
                    currentMatch.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }
        }
        
        // Clear all highlights
        function clearHighlights() {
            transcriptSegments.forEach(segment => {
                const textElement = segment.querySelector('.transcript-text');
                if (textElement) {
                    textElement.innerHTML = textElement.textContent;
                }
                segment.classList.remove('hidden');
            });
            resultsCounter.textContent = '';
        }
        
        // Event listeners
        searchInput.addEventListener('input', performSearch);
        
        clearButton.addEventListener('click', () => {
            searchInput.value = '';
            clearHighlights();
            resultsCounter.textContent = '';
        });
        
        // Add navigation button event listeners
        prevMatch.addEventListener('click', () => {
            navigateMatches('previous');
        });
        
        nextMatch.addEventListener('click', () => {
            navigateMatches('next');
        });
        
        // Add keyboard navigation for search results
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    // Shift+Enter to go to previous match
                    navigateMatches('previous');
                } else {
                    // Enter to go to next match
                    navigateMatches('next');
                }
            }
        });
    }
</script>
{% endblock %} 